#!/bin/bash

# Variables de Netplan
NETPLAN_DIR="/etc/netplan"
STATIC_CONFIG="$NETPLAN_DIR/static.bak"
ORIGINAL_CONFIG="$NETPLAN_DIR/original.bak"
ACTIVE_CONFIG="$NETPLAN_DIR/50-cloud-init.yaml"

# Variables de Bind9
DNS_ZONE_FILE="/etc/bind/db.reprobados.com"
NAMED_CONF="/etc/bind/named.conf"
NAMED_OPTIONS="/etc/bind/named.conf.options"

echo "[INFO] Restaurando configuración de red para tener acceso a Internet..."
if [ -f "$ORIGINAL_CONFIG" ]; then
    sudo cp "$ORIGINAL_CONFIG" "$ACTIVE_CONFIG"
    sudo netplan apply
    echo "[INFO] Red restaurada temporalmente para descargar paquetes."
else
    echo "[ERROR] No se encontró el archivo original.bak. Revisa la configuración de Netplan."
    exit 1
fi

# Instalando Bind9
echo "[INFO] Instalando Bind9..."
sudo apt update && sudo apt install -y bind9 bind9utils

if [ $? -ne 0 ]; then
    echo "[ERROR] No se pudo instalar Bind9. Revisa la conexión a Internet."
    exit 1
fi

echo "[INFO] Restaurando configuración de IP estática..."
if [ -f "$STATIC_CONFIG" ]; then
    sudo cp "$STATIC_CONFIG" "$ACTIVE_CONFIG"
    sudo netplan apply
    echo "[INFO] Configuración de IP estática aplicada."
else
    echo "[ERROR] No se encontró el archivo static.bak. Revisa la configuración de Netplan."
    exit 1
fi

echo "[INFO] Configurando Bind9 para la zona reprobados.com..."

# Crear archivo named.conf
sudo bash -c "cat > $NAMED_CONF" <<EOF
// Archivo de configuración principal de BIND9
include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

zone "reprobados.com" IN {
    type master;
    file "/etc/bind/db.reprobados.com";
};
EOF

echo "[INFO] Archivo named.conf configurado correctamente."